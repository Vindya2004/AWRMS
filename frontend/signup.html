
<!doctype html>
<html lang="si">
<head>
    <meta charset="utf-8" />
    <title>Auth | Sign In / Sign Up</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- intl-tel-input CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.css"/>

    <style>
        :root {
            /*--primary: #7c3aed;*/
            /*--primary-dark: #6d28d9;*/
            /*--secondary: #10b981;*/
            /*--accent: #f59e0b;*/
            /*--dark: #1f2937;*/
            /*--light: #f9fafb;*/
            /*--gray: #9ca3af;*/
            /*--error: #ef4444;*/
            --primary: #3b7d3b; /* Earthy green for Ayurveda */
            --primary-dark: #2e5c2e;
            --secondary: #d4a017; /* Saffron yellow */
            --accent: #8b4513; /* Herbal brown */
            --dark: #2f2f2f;
            --light: #f5f5e8; /* Parchment off-white */
            --gray: #6b7280;
            --error: #9b2c2c;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #4a7043 0%, #8b5a2b 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            font-family: 'Poppins', sans-serif;
        }

        .container {
            position: relative;
            width: 100%;
            max-width: 900px;
            height: 550px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            overflow: hidden;
            backdrop-filter: blur(10px);
            display: flex;
        }

        .form-container {
            width: 50%;
            padding: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            transition: all 0.6s ease-in-out;
            position: relative;
        }

        .form-box {
            width: 100%;
        }

        .form-box h1 {
            font-family: 'Montserrat', sans-serif;
            font-size: 32px;
            color: var(--dark);
            text-align: center;
            margin-bottom: 10px;
            font-weight: 700;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .form-subtitle {
            text-align: center;
            color: var(--gray);
            margin-bottom: 30px;
            font-size: 14px;
        }

        .input-box {
            position: relative;
            margin-bottom: 20px;
        }

        .input-box input {
            width: 100%;
            padding: 16px 20px 16px 50px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s;
            background: var(--light);
            color: var(--dark);
        }

        .input-box input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2);
            transform: translateY(-2px);
        }

        .input-box i {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
            font-size: 20px;
            transition: all 0.3s;
        }

        .input-box input:focus + i {
            color: var(--primary);
        }

        .forgot-link {
            text-align: right;
            margin: -10px 0 20px;
        }

        .forgot-link a {
            color: var(--primary);
            font-size: 14px;
            text-decoration: none;
            transition: all 0.3s;
            font-weight: 500;
        }

        .forgot-link a:hover {
            color: var(--primary-dark);
            text-decoration: underline;
        }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 6px rgba(124, 58, 237, 0.3);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(124, 58, 237, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .toggle-container {
            width: 50%;
            position: relative;
            overflow: hidden;
        }

        .toggle-panel {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px;
            text-align: center;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            transition: all 0.6s ease-in-out;
        }

        .toggle-left {
            transform: translateX(-100%);
        }

        .toggle-right {
            right: 0;
            transform: translateX(0);
        }

        .container.active .toggle-left {
            transform: translateX(0);
        }

        .container.active .toggle-right {
            transform: translateX(100%);
        }

        .toggle-panel h2 {
            font-family: 'Montserrat', sans-serif;
            font-size: 32px;
            margin-bottom: 20px;
            font-weight: 700;
        }

        .toggle-panel p {
            font-size: 16px;
            margin-bottom: 30px;
            opacity: 0.9;
        }

        .toggle-btn {
            padding: 12px 30px;
            border: 2px solid white;
            border-radius: 50px;
            background: transparent;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toggle-btn:hover {
            background: white;
            color: var(--primary);
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .phone-error {
            color: var(--error);
            text-align: left;
            font-size: 12px;
            display: none;
            margin-top: 5px;
            font-weight: 500;
        }

        .feature-icon {
            font-size: 50px;
            margin-bottom: 20px;
            opacity: 0.9;
        }

        /* Animation for form switch */
        .login-form {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 1;
            transform: translateX(0);
            pointer-events: all;
            padding: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            transition: all 0.6s ease-in-out;
        }

        .register-form {
            opacity: 0;
            transform: translateX(100%);
            pointer-events: none;
            transition: all 0.6s ease-in-out;
        }

        .container.active .login-form {
            opacity: 0;
            transform: translateX(-100%);
            pointer-events: none;
        }

        .container.active .register-form {
            opacity: 1;
            transform: translateX(0);
            pointer-events: all;
        }

        /* Alert styles */
        .alert {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                height: auto;
                max-width: 400px;
            }

            .form-container, .toggle-container {
                width: 100%;
            }

            .toggle-container {
                height: 200px;
            }

            .form-box {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="form-container">
        <!-- Sign In -->
        <div class="form-box login-form">
            <h1>Sign In</h1>
            <p class="form-subtitle">Access your account</p>
            <form id="loginForm" novalidate>
                <div class="input-box">
                    <input id="loginEmail" type="email" placeholder="Email" required />
                    <i class="fas fa-envelope"></i>
                </div>
                <div class="input-box">
                    <input id="loginPassword" type="password" placeholder="Password" required />
                    <i class="fas fa-lock"></i>
                </div>
                <div class="forgot-link">
                    <a href="#">Forgot Password?</a>
                </div>
                <button id="loginBtn" type="submit" class="btn">Sign In</button>
            </form>
            <div id="loginMsg" class="alert"></div>
        </div>

        <!-- Sign Up -->
        <div class="form-box register-form">
            <h1>Create Account</h1>

            <form id="signupForm" novalidate>
                <div class="input-box">
                    <input id="name" type="text" placeholder="Full Name" required />
                    <i class="fas fa-user"></i>
                </div>
                <div class="input-box">
                    <input id="signupEmail" type="email" placeholder="Email" required />
                    <i class="fas fa-envelope"></i>
                </div>
                <div class="input-box">
                    <input id="contact" type="tel" placeholder="Contact" />
                    <i class="fas fa-phone"></i>
                    <div class="phone-error" id="phone-error">Invalid phone number</div>
                </div>
                <div class="input-box">
                    <input id="signupPassword" type="password" placeholder="Password" required />
                    <i class="fas fa-lock"></i>
                </div>
                <div class="input-box">
                    <input id="signupConfirm" type="password" placeholder="Confirm Password" required />
                    <i class="fas fa-lock"></i>
                </div>
                <button id="signupBtn" type="submit" class="btn">Register</button>
            </form>
            <div id="signupMsg" class="alert"></div>
        </div>
    </div>

    <div class="toggle-container">
        <div class="toggle-panel toggle-right">
            <i class="fas fa-user-plus feature-icon"></i>
            <h2>Hello, Friend!</h2>
            <p>Don't have an account? Register now to get started.</p>
            <button class="toggle-btn register-btn">Sign Up</button>
        </div>
        <div class="toggle-panel toggle-left">
            <i class="fas fa-sign-in-alt feature-icon"></i>
            <h2>Welcome Back!</h2>
            <p>Already have an account? Sign in to continue.</p>
            <button class="toggle-btn login-btn">Sign In</button>
        </div>
    </div>
</div>

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<!-- intl-tel-input -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>
<!-- Font Awesome for icons -->
<script src="https://kit.fontawesome.com/a076d05399.js"></script>

<script>
    // Toggle SignIn/SignUp
    const container = document.querySelector('.container');
    const registerBtn = document.querySelectorAll('.register-btn');
    const loginBtn = document.querySelectorAll('.login-btn');

    registerBtn.forEach(b => b.addEventListener('click', () => container.classList.add('active')));
    loginBtn.forEach(b => b.addEventListener('click', () => container.classList.remove('active')));

    const API_BASE = "http://localhost:8080/api/v1";

    // Helpers
    function showMsg(sel, text, ok=false){
        const el = document.querySelector(sel);
        el.textContent = text;
        el.className = 'alert ' + (ok ? 'alert-success' : 'alert-error');
        el.style.display = 'block';
    }
    function clearMsg(sel){
        const el = document.querySelector(sel);
        el.textContent = '';
        el.style.display = 'none';
        el.className = 'alert';
    }
    function extractAuth(json){
        const data = json?.data ?? json?.content ?? json?.result ?? json?.payload ?? null;
        const token = data?.token ?? json?.token ?? null;
        const email = data?.email ?? json?.email ?? null;
        return { token, email };
    }
    function saveToLocalStorage(key, value, days){
        const now = new Date();
        const expiryTime = now.getTime() + days * 24 * 60 * 60 * 1000;
        const data = { value, expiry: expiryTime };
        localStorage.setItem(key, JSON.stringify(data));
    }
    function showDashboard(msg){
        alert(msg);
    }

    document.addEventListener("DOMContentLoaded", function () {
        // ====== intl-tel-input for phone ======
        const phoneInputField = document.querySelector("#contact");
        const phoneError = document.querySelector("#phone-error");
        const signupBtn = document.querySelector("#signupBtn");

        const iti = window.intlTelInput(phoneInputField, {
            initialCountry: "lk",
            preferredCountries: ["lk", "us", "gb", "in", "au"],
            separateDialCode: true,
            utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js",
        });

        function validatePhoneNumber(){
            const phoneNumber = phoneInputField.value.trim();
            const phoneRegex = /^07\d{8}$/; // SL mobile 07XXXXXXXX

            if (phoneNumber !== "" && (!iti.isValidNumber() || !phoneRegex.test(phoneNumber))) {
                phoneError.style.display = "block";
                phoneError.textContent = "Invalid phone number format!";
                phoneInputField.classList.add("invalid");
                signupBtn.disabled = true;
            } else {
                phoneError.style.display = "none";
                phoneInputField.classList.remove("invalid");
                signupBtn.disabled = false;
            }
        }
        phoneInputField.addEventListener("input", validatePhoneNumber);

        // ====== Sign Up ======
        $("#signupForm").on("submit", function(e){
            e.preventDefault();
            clearMsg("#signupMsg");

            const name = $("#name").val().trim();
            const email = $("#signupEmail").val().trim();
            const contactRaw = $("#contact").val().trim();
            const contact = iti.getNumber(); // +94xxxxxxxxx
            const password = $("#signupPassword").val();
            const confirm = $("#signupConfirm").val();

            if (!name || !email || !password){
                showMsg("#signupMsg", "Name, Email, Password aniwaren danna.", false);
                return;
            }
            if (password !== confirm){
                showMsg("#signupMsg", "Passwords match wenne ne. Please check.", false);
                return;
            }
            if (contactRaw && (!iti.isValidNumber() || !/^07\d{8}$/.test(contactRaw))){
                showMsg("#signupMsg", "Please enter a valid phone number!", false);
                return;
            }

            $("#signupBtn").prop("disabled", true).text("Registering...");

            $.ajax({
                url: `${API_BASE}/user/register`,
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({ name, email, contact, password }),
                success: function (response) {
                    const { token } = extractAuth(response);
                    if (token){
                        localStorage.setItem("token", token);
                    }
                    showMsg("#signupMsg", "✅ Signup Successful!", true);
                    // Go to Sign In pane
                    setTimeout(() => {
                        container.classList.remove('active');
                        $("#signupBtn").prop("disabled", false).text("Register");
                        clearMsg("#signupMsg");
                    }, 900);
                },
                error: function (xhr) {
                    const msg = xhr?.responseJSON?.message || "Unknown error";
                    showMsg("#signupMsg", "❌ Signup Failed: " + msg, false);
                },
                complete: function () {
                    $("#signupBtn").prop("disabled", false).text("Register");
                }
            });
        });

        // ====== Sign In ======
        $("#loginForm").on("submit", function(e){
            e.preventDefault();
            clearMsg("#loginMsg");

            const email = $("#loginEmail").val().trim();
            const password = $("#loginPassword").val();

            if (!email || !password){
                showMsg("#loginMsg", "Email saha Password danna.", false);
                return;
            }

            $.ajax({
                url: `${API_BASE}/auth/authentication`,
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify({ email, password }),
                success: function (response) {
                    const { token } = extractAuth(response);
                    if (!token){
                        showMsg("#loginMsg", "Token labunane. Backend response eka balanna.", false);
                        return;
                    }
                    localStorage.setItem("token", token);
                    getUsername(email);
                    checkUserRole();
                    showMsg("#loginMsg", "✅ Login success!", true);
                },
                error: function (xhr) {
                    const msg = xhr?.responseJSON?.message || "Login failed.";
                    showMsg("#loginMsg", "❌ " + msg, false);
                }
            });
        });
    });

    // ====== Role check using available endpoints ======
    function checkUserRole(){
        const token = localStorage.getItem("token");
        if (!token){
            showDashboard("Unauthorized: Please log in.");
            return;
        }

        function checkRole(path, onOk, onFail){
            $.ajax({
                url: `${API_BASE}/admin/${path}`,
                type: "GET",
                headers: {"Authorization": `Bearer ${token}`},
                success: onOk,
                error: function(jqXHR, textStatus, errorThrown){
                    if (jqXHR.status === 403){
                        if (onFail) onFail(jqXHR, textStatus, errorThrown);
                    } else {
                        console.error(`Error checking role at ${path}:`, textStatus, errorThrown);
                        if (onFail) onFail(jqXHR, textStatus, errorThrown);
                    }
                }
            });
        }

        checkRole("admin",
            function (){
                console.log("hi admin");
                window.location.href = "adminDashboard.html";
            },
            function (){
                checkRole("user",
                    function (){
                        console.log("hi user");
                        window.location.href = "index.html";
                    },
                    function (){
                        showDashboard("Unauthorized: Access denied.");
                    }
                );
            }
        );
    }

    // ====== Load user profile by email and store ======
    function getUsername(emailFromLoginInput){
        const email = (emailFromLoginInput || $('#loginEmail').val() || '').trim();
        const token = localStorage.getItem("token");
        if (!email){ return; }

        $.ajax({
            url: `${API_BASE}/user/getUserByEmail?email=${encodeURIComponent(email)}`,
            method: 'GET',
            contentType: 'application/json',
            headers: { 'Authorization': `Bearer ${token}` },
            success: function (response) {
                const data = response?.data;
                if (data){
                    saveToLocalStorage("name", data.name, 5);
                    saveToLocalStorage("email", data.email, 5);
                    saveToLocalStorage("role", data.role, 5);
                    console.log("User retrieved successfully!");
                } else {
                    alert("User not found.");
                }
            },
            error: function (error) {
                console.error('Error:', error);
                alert(error.responseJSON?.message || 'Failed to get user details.');
            }
        });
    }
</script>
</body>
</html>